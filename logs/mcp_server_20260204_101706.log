2026-02-04 10:17:06,620 - INFO - __main__ - Environment loaded
2026-02-04 10:17:06,621 - INFO - __main__ -   Host: fieldsync-postgres-test-ef7b1fb.c6h0n29wfk5h.us-east-1.rds.amazonaws.com
2026-02-04 10:17:06,621 - INFO - __main__ -   User: postgres
2026-02-04 10:17:06,635 - INFO - __main__ - ============================================================
2026-02-04 10:17:06,635 - INFO - __main__ - Dynamic Database MCP Server Starting...
2026-02-04 10:17:06,635 - INFO - __main__ - ============================================================
2026-02-04 10:17:06,635 - INFO - __main__ - Database Type: postgres
2026-02-04 10:17:06,636 - INFO - __main__ - Database Host: fieldsync-postgres-test-ef7b1fb.c6h0n29wfk5h.us-east-1.rds.amazonaws.com
2026-02-04 10:17:06,636 - INFO - __main__ - Database Name: postgres
2026-02-04 10:17:06,636 - INFO - __main__ - Database User: postgres
2026-02-04 10:17:06,636 - INFO - __main__ - Testing database connection...
2026-02-04 10:17:07,140 - INFO - __main__ - ✓ Successfully connected to database
2026-02-04 10:17:07,140 - INFO - __main__ - Caching database schema...
2026-02-04 10:18:38,721 - INFO - __main__ - ✓ Cached schema with 96 tables
2026-02-04 10:18:38,722 - INFO - __main__ - Starting MCP server stdio interface...
2026-02-04 10:18:38,742 - INFO - mcp.server.lowlevel.server - Processing request of type ListToolsRequest
2026-02-04 10:18:46,165 - INFO - mcp.server.lowlevel.server - Processing request of type CallToolRequest
2026-02-04 10:18:46,594 - ERROR - __main__ - Database error: column d.safetyClimbId does not exist
LINE 13: ...                     LEFT JOIN safety_climb sc ON d."safetyC...
                                                              ^

2026-02-04 10:18:46,595 - ERROR - __main__ - Error in query_inspection_data: Database error: column d.safetyClimbId does not exist
LINE 13: ...                     LEFT JOIN safety_climb sc ON d."safetyC...
                                                              ^
Traceback (most recent call last):
  File "C:\Users\LucyKien\mcp_testing\mcp_server.py", line 264, in execute_query
    cursor.execute(query, params)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "C:\Users\LucyKien\mcp_testing\.venv\Lib\site-packages\psycopg2\extras.py", line 236, in execute
    return super().execute(query, vars)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^
psycopg2.errors.UndefinedColumn: column d.safetyClimbId does not exist
LINE 13: ...                     LEFT JOIN safety_climb sc ON d."safetyC...
                                                              ^


During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\LucyKien\mcp_testing\mcp_server.py", line 985, in call_tool
    results_data['deficiency'] = db.execute_query(query, tuple(params))
                                 ~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\LucyKien\mcp_testing\mcp_server.py", line 278, in execute_query
    raise Exception(f"Database error: {str(e)}")
Exception: Database error: column d.safetyClimbId does not exist
LINE 13: ...                     LEFT JOIN safety_climb sc ON d."safetyC...
                                                              ^

2026-02-04 10:18:48,462 - INFO - mcp.server.lowlevel.server - Processing request of type CallToolRequest
2026-02-04 10:18:50,220 - INFO - mcp.server.lowlevel.server - Processing request of type CallToolRequest
2026-02-04 10:18:52,036 - INFO - mcp.server.lowlevel.server - Processing request of type CallToolRequest
2026-02-04 10:18:53,949 - INFO - mcp.server.lowlevel.server - Processing request of type CallToolRequest
2026-02-04 10:18:56,012 - INFO - mcp.server.lowlevel.server - Processing request of type CallToolRequest
2026-02-04 10:18:57,566 - INFO - mcp.server.lowlevel.server - Processing request of type CallToolRequest
2026-02-04 10:19:04,030 - INFO - mcp.server.lowlevel.server - Processing request of type CallToolRequest
2026-02-04 10:19:04,031 - INFO - __main__ - Executing query: Find all deficiencies related to safety climbs by searching for climb-related terms in deficiency fields
2026-02-04 10:19:04,032 - INFO - __main__ - SQL: SELECT DISTINCT 
    d.id as deficiency_id,
    d.name as deficiency_name,
    d.deficiencyCode,
    d.deficiencyLocation,
    d.severity,
    d.description,
    d.elevation,
    s.id as survey_id,
    s.name as survey_name,
    sb.id as structure_id,
    sb.name as structure_name,
    sb.structureType,
    o.name as organization_name
FROM deficiency d
LEFT JOIN survey s ON d.surveyId = s.id
LEFT JOIN structure_base sb ON s.structureBaseId = sb.id
LEFT JOIN organization o ON d.organizationId = o.id
WHERE LOWER(d.deficiencyLocation) LIKE '%safety%climb%' 
   OR LOWER(d.deficiencyLocation) LIKE '%climb%' 
   OR LOWER(d.description) LIKE '%safety%climb%'
   OR LOWER(d.description) LIKE '%climb%'
   OR LOWER(d.name) LIKE '%safety%climb%'
   OR LOWER(d.name) LIKE '%climb%'
ORDER BY o.name, sb.name, d.severity, d.elevation
2026-02-04 10:19:04,032 - INFO - __main__ - Params: ()
2026-02-04 10:19:04,436 - ERROR - __main__ - Database error: column d.surveyid does not exist
LINE 16: LEFT JOIN survey s ON d.surveyId = s.id
                               ^
HINT:  Perhaps you meant to reference the column "d.surveyId".

2026-02-04 10:19:04,437 - ERROR - __main__ - Error in execute_query: Database error: column d.surveyid does not exist
LINE 16: LEFT JOIN survey s ON d.surveyId = s.id
                               ^
HINT:  Perhaps you meant to reference the column "d.surveyId".
Traceback (most recent call last):
  File "C:\Users\LucyKien\mcp_testing\mcp_server.py", line 266, in execute_query
    cursor.execute(query)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\LucyKien\mcp_testing\.venv\Lib\site-packages\psycopg2\extras.py", line 236, in execute
    return super().execute(query, vars)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^
psycopg2.errors.UndefinedColumn: column d.surveyid does not exist
LINE 16: LEFT JOIN survey s ON d.surveyId = s.id
                               ^
HINT:  Perhaps you meant to reference the column "d.surveyId".


During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\LucyKien\mcp_testing\mcp_server.py", line 665, in call_tool
    results = db.execute_query(query, params)
  File "C:\Users\LucyKien\mcp_testing\mcp_server.py", line 278, in execute_query
    raise Exception(f"Database error: {str(e)}")
Exception: Database error: column d.surveyid does not exist
LINE 16: LEFT JOIN survey s ON d.surveyId = s.id
                               ^
HINT:  Perhaps you meant to reference the column "d.surveyId".

2026-02-04 10:19:10,437 - INFO - mcp.server.lowlevel.server - Processing request of type CallToolRequest
2026-02-04 10:19:10,441 - INFO - __main__ - Executing query: Find all deficiencies related to safety climbs by searching for climb-related terms in deficiency fields
2026-02-04 10:19:10,441 - INFO - __main__ - SQL: SELECT DISTINCT 
    d.id as deficiency_id,
    d.name as deficiency_name,
    d."deficiencyCode",
    d."deficiencyLocation",
    d.severity,
    d.description,
    d.elevation,
    s.id as survey_id,
    s.name as survey_name,
    sb.id as structure_id,
    sb.name as structure_name,
    sb."structureType",
    o.name as organization_name
FROM deficiency d
LEFT JOIN survey s ON d."surveyId" = s.id
LEFT JOIN structure_base sb ON s."structureBaseId" = sb.id
LEFT JOIN organization o ON d."organizationId" = o.id
WHERE LOWER(d."deficiencyLocation") LIKE '%safety%climb%' 
   OR LOWER(d."deficiencyLocation") LIKE '%climb%' 
   OR LOWER(d.description) LIKE '%safety%climb%'
   OR LOWER(d.description) LIKE '%climb%'
   OR LOWER(d.name) LIKE '%safety%climb%'
   OR LOWER(d.name) LIKE '%climb%'
ORDER BY o.name, sb.name, d.severity, d.elevation
2026-02-04 10:19:10,441 - INFO - __main__ - Params: ()
2026-02-04 10:19:10,885 - ERROR - __main__ - Database error: column s.structureBaseId does not exist
LINE 17: LEFT JOIN structure_base sb ON s."structureBaseId" = sb.id
                                        ^

2026-02-04 10:19:10,886 - ERROR - __main__ - Error in execute_query: Database error: column s.structureBaseId does not exist
LINE 17: LEFT JOIN structure_base sb ON s."structureBaseId" = sb.id
                                        ^
Traceback (most recent call last):
  File "C:\Users\LucyKien\mcp_testing\mcp_server.py", line 266, in execute_query
    cursor.execute(query)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\LucyKien\mcp_testing\.venv\Lib\site-packages\psycopg2\extras.py", line 236, in execute
    return super().execute(query, vars)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^
psycopg2.errors.UndefinedColumn: column s.structureBaseId does not exist
LINE 17: LEFT JOIN structure_base sb ON s."structureBaseId" = sb.id
                                        ^


During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\LucyKien\mcp_testing\mcp_server.py", line 665, in call_tool
    results = db.execute_query(query, params)
  File "C:\Users\LucyKien\mcp_testing\mcp_server.py", line 278, in execute_query
    raise Exception(f"Database error: {str(e)}")
Exception: Database error: column s.structureBaseId does not exist
LINE 17: LEFT JOIN structure_base sb ON s."structureBaseId" = sb.id
                                        ^

2026-02-04 10:19:12,806 - INFO - mcp.server.lowlevel.server - Processing request of type CallToolRequest
2026-02-04 10:19:14,665 - INFO - mcp.server.lowlevel.server - Processing request of type CallToolRequest
2026-02-04 10:19:16,546 - INFO - mcp.server.lowlevel.server - Processing request of type CallToolRequest
2026-02-04 10:19:19,933 - INFO - mcp.server.lowlevel.server - Processing request of type CallToolRequest
2026-02-04 10:19:19,936 - INFO - __main__ - Executing query: Check for site-related columns in structure tables
2026-02-04 10:19:19,936 - INFO - __main__ - SQL: SELECT 
    table_name,
    column_name,
    data_type,
    is_nullable,
    column_default
FROM information_schema.columns 
WHERE column_name LIKE '%site%' 
AND table_name IN ('structure_base', 'tower', 'mast', 'monopole', 'guy_supported_tower')
ORDER BY table_name, column_name
2026-02-04 10:19:19,937 - INFO - __main__ - Params: ()
2026-02-04 10:19:22,247 - INFO - mcp.server.lowlevel.server - Processing request of type CallToolRequest
2026-02-04 10:19:24,091 - INFO - mcp.server.lowlevel.server - Processing request of type CallToolRequest
2026-02-04 10:19:30,230 - INFO - mcp.server.lowlevel.server - Processing request of type CallToolRequest
2026-02-04 10:19:30,231 - INFO - __main__ - Executing query: Find all towers with safety climb deficiencies by searching for climb-related terms and joining through the proper relationships
2026-02-04 10:19:30,232 - INFO - __main__ - SQL: SELECT DISTINCT 
    d.id as deficiency_id,
    d.name as deficiency_name,
    d."deficiencyCode",
    d."deficiencyLocation",
    d.severity,
    d.description,
    d.elevation,
    s.id as survey_id,
    s.name as survey_name,
    st.id as structure_id,
    st.name as structure_name,
    st.type as structure_type,
    st."safetyClimbPresent",
    site.name as site_name,
    site.address as site_address,
    o.name as organization_name
FROM deficiency d
LEFT JOIN survey s ON d."surveyId" = s.id
LEFT JOIN site_visit sv ON s."siteVisitId" = sv.id
LEFT JOIN site ON sv."siteId" = site.id
LEFT JOIN structure st ON site.id = st."siteId"
LEFT JOIN organization o ON d."organizationId" = o.id
WHERE LOWER(d."deficiencyLocation") LIKE '%safety%climb%' 
   OR LOWER(d."deficiencyLocation") LIKE '%climb%' 
   OR LOWER(d.description) LIKE '%safety%climb%'
   OR LOWER(d.description) LIKE '%climb%'
   OR LOWER(d.name) LIKE '%safety%climb%'
   OR LOWER(d.name) LIKE '%climb%'
ORDER BY o.name, site.name, st.name, d.severity, d.elevation
2026-02-04 10:19:30,232 - INFO - __main__ - Params: ()
2026-02-04 10:19:36,750 - INFO - mcp.server.lowlevel.server - Processing request of type CallToolRequest
2026-02-04 10:19:36,755 - INFO - __main__ - Executing query: Find all towers with safety climb systems that have associated deficiencies
2026-02-04 10:19:36,755 - INFO - __main__ - SQL: SELECT DISTINCT 
    sc."surveyId",
    s.name as survey_name,
    st.id as structure_id,
    st.name as structure_name,
    st.type as structure_type,
    st."safetyClimbPresent",
    site.name as site_name,
    site.address as site_address,
    o.name as organization_name,
    COUNT(d.id) as deficiency_count,
    STRING_AGG(DISTINCT d."deficiencyCode", ', ') as deficiency_codes,
    STRING_AGG(DISTINCT d.severity, ', ') as severities
FROM safety_climb sc
LEFT JOIN survey s ON sc."surveyId" = s.id
LEFT JOIN site_visit sv ON s."siteVisitId" = sv.id
LEFT JOIN site ON sv."siteId" = site.id
LEFT JOIN structure st ON site.id = st."siteId"
LEFT JOIN organization o ON sc."organizationId" = o.id
LEFT JOIN deficiency d ON d."safetyClimbId" = sc.id
WHERE d.id IS NOT NULL  -- Only structures with deficiencies
GROUP BY sc."surveyId", s.name, st.id, st.name, st.type, st."safetyClimbPresent", 
         site.name, site.address, o.name
ORDER BY o.name, site.name, st.name, deficiency_count DESC
2026-02-04 10:19:36,756 - INFO - __main__ - Params: ()
2026-02-04 10:19:37,191 - ERROR - __main__ - Database error: column sc.surveyId does not exist
LINE 15: LEFT JOIN survey s ON sc."surveyId" = s.id
                               ^

2026-02-04 10:19:37,191 - ERROR - __main__ - Error in execute_query: Database error: column sc.surveyId does not exist
LINE 15: LEFT JOIN survey s ON sc."surveyId" = s.id
                               ^
Traceback (most recent call last):
  File "C:\Users\LucyKien\mcp_testing\mcp_server.py", line 266, in execute_query
    cursor.execute(query)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\LucyKien\mcp_testing\.venv\Lib\site-packages\psycopg2\extras.py", line 236, in execute
    return super().execute(query, vars)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^
psycopg2.errors.UndefinedColumn: column sc.surveyId does not exist
LINE 15: LEFT JOIN survey s ON sc."surveyId" = s.id
                               ^


During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\LucyKien\mcp_testing\mcp_server.py", line 665, in call_tool
    results = db.execute_query(query, params)
  File "C:\Users\LucyKien\mcp_testing\mcp_server.py", line 278, in execute_query
    raise Exception(f"Database error: {str(e)}")
Exception: Database error: column sc.surveyId does not exist
LINE 15: LEFT JOIN survey s ON sc."surveyId" = s.id
                               ^

2026-02-04 10:19:38,996 - INFO - mcp.server.lowlevel.server - Processing request of type CallToolRequest
2026-02-04 10:19:44,266 - INFO - mcp.server.lowlevel.server - Processing request of type CallToolRequest
2026-02-04 10:19:44,270 - INFO - __main__ - Executing query: Find all towers with safety climb systems that have associated deficiencies using proper table relationships
2026-02-04 10:19:44,270 - INFO - __main__ - SQL: SELECT DISTINCT 
    st.id as structure_id,
    st.name as structure_name,
    st.type as structure_type,
    st."safetyClimbPresent",
    site.name as site_name,
    site.address as site_address,
    o.name as organization_name,
    COUNT(DISTINCT d.id) as deficiency_count,
    STRING_AGG(DISTINCT d."deficiencyCode", ', ' ORDER BY d."deficiencyCode") as deficiency_codes,
    STRING_AGG(DISTINCT CAST(d.severity as TEXT), ', ' ORDER BY d.severity) as severities,
    STRING_AGG(DISTINCT d."deficiencyLocation", ', ' ORDER BY d."deficiencyLocation") as deficiency_locations
FROM safety_climb sc
LEFT JOIN structure_base sb ON sc."structureBaseId" = sb.id
LEFT JOIN structure st ON sb."structureId" = st.id
LEFT JOIN site ON st."siteId" = site.id
LEFT JOIN organization o ON sc."organizationId" = o.id
LEFT JOIN deficiency d ON d."safetyClimbId" = sc.id
WHERE d.id IS NOT NULL  -- Only structures with safety climb deficiencies
GROUP BY st.id, st.name, st.type, st."safetyClimbPresent", 
         site.name, site.address, o.name
ORDER BY o.name, site.name, st.name, deficiency_count DESC
2026-02-04 10:19:44,271 - INFO - __main__ - Params: ()
2026-02-04 10:19:45,530 - ERROR - __main__ - Database error: column d.safetyClimbId does not exist
LINE 18: LEFT JOIN deficiency d ON d."safetyClimbId" = sc.id
                                   ^

2026-02-04 10:19:45,531 - ERROR - __main__ - Error in execute_query: Database error: column d.safetyClimbId does not exist
LINE 18: LEFT JOIN deficiency d ON d."safetyClimbId" = sc.id
                                   ^
Traceback (most recent call last):
  File "C:\Users\LucyKien\mcp_testing\mcp_server.py", line 266, in execute_query
    cursor.execute(query)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\LucyKien\mcp_testing\.venv\Lib\site-packages\psycopg2\extras.py", line 236, in execute
    return super().execute(query, vars)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^
psycopg2.errors.UndefinedColumn: column d.safetyClimbId does not exist
LINE 18: LEFT JOIN deficiency d ON d."safetyClimbId" = sc.id
                                   ^


During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\LucyKien\mcp_testing\mcp_server.py", line 665, in call_tool
    results = db.execute_query(query, params)
  File "C:\Users\LucyKien\mcp_testing\mcp_server.py", line 278, in execute_query
    raise Exception(f"Database error: {str(e)}")
Exception: Database error: column d.safetyClimbId does not exist
LINE 18: LEFT JOIN deficiency d ON d."safetyClimbId" = sc.id
                                   ^

2026-02-04 10:20:03,745 - INFO - mcp.server.lowlevel.server - Processing request of type CallToolRequest
2026-02-04 10:20:03,747 - INFO - __main__ - Executing query: Check for safety climb related columns in deficiency table
2026-02-04 10:20:03,747 - INFO - __main__ - SQL: SELECT 
    column_name,
    data_type,
    is_nullable
FROM information_schema.columns 
WHERE table_name = 'deficiency'
AND column_name LIKE '%safety%' 
OR (table_name = 'deficiency' AND column_name LIKE '%climb%')
ORDER BY column_name
2026-02-04 10:20:03,747 - INFO - __main__ - Params: ()
2026-02-04 10:20:11,409 - INFO - mcp.server.lowlevel.server - Processing request of type CallToolRequest
2026-02-04 10:20:11,410 - INFO - __main__ - Executing query: Find all towers that have safety climb deficiencies based on text search and provide summary statistics
2026-02-04 10:20:11,411 - INFO - __main__ - SQL: SELECT DISTINCT 
    st.id as structure_id,
    st.name as structure_name,
    st.type as structure_type,
    st."safetyClimbPresent",
    site.name as site_name,
    site.address as site_address,
    o.name as organization_name,
    COUNT(DISTINCT d.id) as deficiency_count,
    STRING_AGG(DISTINCT d."deficiencyCode", ', ' ORDER BY d."deficiencyCode") as deficiency_codes,
    STRING_AGG(DISTINCT CAST(d.severity as TEXT), ', ' ORDER BY d.severity) as severities,
    MIN(CAST(d.severity as INTEGER)) as highest_severity,
    STRING_AGG(DISTINCT d."deficiencyLocation", ', ' ORDER BY d."deficiencyLocation") as locations
FROM deficiency d
LEFT JOIN survey s ON d."surveyId" = s.id
LEFT JOIN site_visit sv ON s."siteVisitId" = sv.id
LEFT JOIN site ON sv."siteId" = site.id
LEFT JOIN structure st ON site.id = st."siteId"
LEFT JOIN organization o ON d."organizationId" = o.id
WHERE (LOWER(d."deficiencyLocation") LIKE '%safety%climb%' 
   OR LOWER(d."deficiencyLocation") LIKE '%climb%' 
   OR LOWER(d.description) LIKE '%safety%climb%'
   OR LOWER(d.description) LIKE '%climb%'
   OR LOWER(d.name) LIKE '%safety%climb%'
   OR LOWER(d.name) LIKE '%climb%')
   AND st.id IS NOT NULL  -- Only include records with valid structure data
GROUP BY st.id, st.name, st.type, st."safetyClimbPresent", 
         site.name, site.address, o.name
ORDER BY o.name, site.name, st.name
2026-02-04 10:20:11,411 - INFO - __main__ - Params: ()
2026-02-04 10:20:11,826 - ERROR - __main__ - Database error: in an aggregate with DISTINCT, ORDER BY expressions must appear in argument list
LINE 11: ...(DISTINCT CAST(d.severity as TEXT), ', ' ORDER BY d.severity...
                                                              ^

2026-02-04 10:20:11,827 - ERROR - __main__ - Error in execute_query: Database error: in an aggregate with DISTINCT, ORDER BY expressions must appear in argument list
LINE 11: ...(DISTINCT CAST(d.severity as TEXT), ', ' ORDER BY d.severity...
                                                              ^
Traceback (most recent call last):
  File "C:\Users\LucyKien\mcp_testing\mcp_server.py", line 266, in execute_query
    cursor.execute(query)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\LucyKien\mcp_testing\.venv\Lib\site-packages\psycopg2\extras.py", line 236, in execute
    return super().execute(query, vars)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^
psycopg2.errors.InvalidColumnReference: in an aggregate with DISTINCT, ORDER BY expressions must appear in argument list
LINE 11: ...(DISTINCT CAST(d.severity as TEXT), ', ' ORDER BY d.severity...
                                                              ^


During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\LucyKien\mcp_testing\mcp_server.py", line 665, in call_tool
    results = db.execute_query(query, params)
  File "C:\Users\LucyKien\mcp_testing\mcp_server.py", line 278, in execute_query
    raise Exception(f"Database error: {str(e)}")
Exception: Database error: in an aggregate with DISTINCT, ORDER BY expressions must appear in argument list
LINE 11: ...(DISTINCT CAST(d.severity as TEXT), ', ' ORDER BY d.severity...
                                                              ^

2026-02-04 10:21:07,291 - INFO - mcp.server.lowlevel.server - Processing request of type CallToolRequest
2026-02-04 10:21:07,294 - INFO - __main__ - Executing query: Find all towers that have safety climb deficiencies and provide summary statistics
2026-02-04 10:21:07,294 - INFO - __main__ - SQL: SELECT DISTINCT 
    st.id as structure_id,
    st.name as structure_name,
    st.type as structure_type,
    st."safetyClimbPresent",
    site.name as site_name,
    site.address as site_address,
    o.name as organization_name,
    COUNT(DISTINCT d.id) as deficiency_count,
    STRING_AGG(DISTINCT d."deficiencyCode", ', ') as deficiency_codes,
    STRING_AGG(DISTINCT CAST(d.severity as TEXT), ', ') as severities,
    MIN(CAST(d.severity as INTEGER)) as highest_severity,
    STRING_AGG(DISTINCT d."deficiencyLocation", ', ') as locations
FROM deficiency d
LEFT JOIN survey s ON d."surveyId" = s.id
LEFT JOIN site_visit sv ON s."siteVisitId" = sv.id
LEFT JOIN site ON sv."siteId" = site.id
LEFT JOIN structure st ON site.id = st."siteId"
LEFT JOIN organization o ON d."organizationId" = o.id
WHERE (LOWER(d."deficiencyLocation") LIKE '%safety%climb%' 
   OR LOWER(d."deficiencyLocation") LIKE '%climb%' 
   OR LOWER(d.description) LIKE '%safety%climb%'
   OR LOWER(d.description) LIKE '%climb%'
   OR LOWER(d.name) LIKE '%safety%climb%'
   OR LOWER(d.name) LIKE '%climb%')
   AND st.id IS NOT NULL  -- Only include records with valid structure data
GROUP BY st.id, st.name, st.type, st."safetyClimbPresent", 
         site.name, site.address, o.name
ORDER BY o.name, site.name, st.name
2026-02-04 10:21:07,294 - INFO - __main__ - Params: ()
